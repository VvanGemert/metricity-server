#!/usr/bin/env ruby
$LOAD_PATH << File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib'))

require 'eventmachine'
require 'metricity-server'

@pid_full = '/tmp/metricity_server.pid'


def start_app(args)
  if args.empty?
    puts 'Metricity Help'
  else
    if [:start, :run, :stop].include? args.first.to_sym
      send(args.first.to_sym)
    end
  end
end

def run
	EM.run{
	 	Signal.trap('INT') { stop }
	 	Signal.trap('TERM'){ stop }
	 	Metricity::Server.start!( ARGV.first || 'start' )
	}
end

def get_pid
	if File.exists?(@pid_full)
		file = File.new(@pid_full, "r")
		pid = file.read
		file.close

		pid
	else
		0
	end
end

def start
	pid = get_pid
	if pid != 0
		warn 'Daemon is already running'
		exit -1
	end

	pid = fork {
		run
	}
	begin
		file = File.new(@pid_full, "w")
		file.write(pid)
		file.close
		Process.detach(pid)
	rescue => exc
		Process.kill('TERM', pid)
		warn "Cannot start daemon: #{exc.message}"
	end
end

def stop
	pid = get_pid
	begin
		EM.stop
	rescue
	end

	if pid != 0
		Process.kill('HUP', pid.to_i)
		File.delete(@pid_full)
		puts 'Stopped'
	else
		warn 'Shutting down..'
	end
end

start_app(ARGV)
